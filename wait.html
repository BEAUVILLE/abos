<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY ‚Äî Validation en cours</title>
  <meta name="theme-color" content="#16a34a"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ‚úÖ ENV (si d√©j√† d√©fini ailleurs, tu peux garder aussi) -->
  <script>
    window.DIGIY_SUPABASE_URL = window.DIGIY_SUPABASE_URL || "https://wesqmwjjtsefyjnluosj.supabase.co";
    window.DIGIY_SUPABASE_ANON_KEY = window.DIGIY_SUPABASE_ANON_KEY || "REMPLIS_TA_ANON_KEY_ICI";
  </script>

  <style>
    :root{
      --bg:#061b14; --card:#0b2a1f; --line:rgba(255,255,255,.14);
      --text:#eafff1; --muted:rgba(234,255,241,.75);
      --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --radius:18px; --shadow:0 18px 50px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; background:var(--bg); color:var(--text); }
    .wrap{ max-width:760px; margin:0 auto; padding:16px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:var(--radius); padding:16px; box-shadow:var(--shadow); }
    h1{ margin:0; font-size:18px; font-weight:1100; }
    p{ margin:8px 0 0; color:var(--muted); line-height:1.4; }
    .hr{ height:1px; background:var(--line); margin:14px 0; }
    .status{
      padding:12px; border-radius:16px; border:1px solid var(--line);
      font-weight:1100; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
    }
    .tag{ font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line); color:var(--muted); }
    .tag.ok{ color: var(--ok); border-color: rgba(34,197,94,.45); }
    .tag.warn{ color: var(--warn); border-color: rgba(245,158,11,.45); }
    .tag.bad{ color: var(--bad); border-color: rgba(239,68,68,.45); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace; }
    .btn{
      width:100%; min-height:50px; border-radius:16px; cursor:pointer;
      border:1px solid var(--line); background:rgba(0,0,0,.10); color:var(--text);
      padding:12px 14px; font-weight:1100;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .row > *{ flex:1; min-width:220px; }
    .small{ font-size:13px; color:var(--muted); line-height:1.35; }
    .box{ border:1px solid var(--line); border-radius:16px; padding:14px; background:rgba(0,0,0,.12); }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <h1>‚è≥ Validation en cours‚Ä¶</h1>
      <p class="small">On v√©rifie ton paiement. D√®s que c‚Äôest confirm√©, on te redirige automatiquement vers ton module.</p>

      <div class="hr"></div>

      <div class="status" id="statusBox">
        <div id="waitText">Connexion‚Ä¶</div>
        <span class="tag warn" id="statusTag">EN COURS</span>
      </div>

      <div class="hr"></div>

      <div class="box">
        <div class="small">R√©f√©rence</div>
        <div class="mono" id="refBox">‚Äî</div>
        <div class="hr"></div>
        <div class="small">Statut / Destination</div>
        <div class="mono" id="destBox">‚Äî</div>
      </div>

      <div class="hr"></div>

      <div class="row">
        <button class="btn" id="btnRetry" type="button">üîÑ R√©essayer</button>
        <button class="btn" id="btnSupport" type="button">üí¨ Support WhatsApp</button>
      </div>

      <p class="small" style="margin-top:12px;">
        Astuce : si tu viens juste d‚Äôenvoyer le re√ßu, laisse un peu. D√®s que le cockpit confirme, √ßa ouvre automatiquement.
      </p>
    </div>
  </div>

  <script>
  (async function(){
    "use strict";

    const SUPPORT_WA = "+221771342889";
    const qp = new URLSearchParams(location.search);
    const ref = (qp.get("ref") || "").trim();

    const $ = (id)=>document.getElementById(id);

    function wa(msg){
      const num = SUPPORT_WA.replace(/\+/g,"");
      location.href = "https://wa.me/" + num + "?text=" + encodeURIComponent(msg);
    }

    function setTag(tone, label){
      const tag = $("statusTag");
      tag.className = "tag " + (tone || "warn");
      tag.textContent = label || "‚Äî";
    }

    function setText(t){ $("waitText").textContent = t; }
    function setDest(t){ $("destBox").textContent = t || "‚Äî"; }

    const SUPABASE_URL = (window.DIGIY_SUPABASE_URL || "").trim();
    const SUPABASE_ANON_KEY = (window.DIGIY_SUPABASE_ANON_KEY || "").trim();

    if(!ref){
      $("refBox").textContent = "‚Äî";
      setText("‚ö†Ô∏è R√©f√©rence manquante. Ouvre la page avec ?ref=XXXX");
      setTag("bad","REF MANQUANTE");
      return;
    }
    $("refBox").textContent = ref;

    if(!window.supabase){
      setText("‚ö†Ô∏è Supabase-js non charg√©.");
      setTag("bad","ERREUR");
      return;
    }
    if(!SUPABASE_URL || !SUPABASE_ANON_KEY || SUPABASE_ANON_KEY === "REMPLIS_TA_ANON_KEY_ICI"){
      setText("‚ö†Ô∏è Config Supabase manquante (URL / ANON KEY).");
      setTag("bad","CONFIG");
      return;
    }

    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth:{ persistSession:false, autoRefreshToken:false, detectSessionInUrl:false }
    });

    async function pollOnce(){
      // ‚úÖ RPC EXISTANTE chez toi
      const { data, error } = await sb.rpc("digiy_pay_check_order", { p_reference: ref });
      if(error) throw error;
      return data;
    }

    let tries = 0;
    const MAX_TRIES = 150;   // ~5 min @2s
    const DELAY = 2000;

    async function loop(){
      setText("‚è≥ Validation en cours‚Ä¶");
      setTag("warn","EN COURS");

      while(tries < MAX_TRIES){
        tries++;

        try{
          const data = await pollOnce();

          // data attendu: { ok, status, url, module, slug, ... }
          if(!data?.ok){
            setDest("En attente‚Ä¶");
            setText("‚è≥ Paiement pas encore confirm√©‚Ä¶ (" + tries + "/" + MAX_TRIES + ")");
            setTag("warn","PENDING");
          } else {
            const st = String(data.status || "active").toLowerCase();
            const url = (data.url || "").trim();
            const mod = (data.module || "").toString();
            const slug = (data.slug || "").toString();

            setDest((mod || "‚Äî") + " / " + (slug || "‚Äî"));

            if(st === "active" || st === "confirmed"){
              if(url){
                setText("‚úÖ Confirm√©. Redirection‚Ä¶");
                setTag("ok","CONFIRM√â");
                location.href = url;
                return;
              }
              setText("‚úÖ Confirm√© mais URL manquante. Contacte support.");
              setTag("bad","URL?");
              return;
            }

            if(st === "rejected" || st === "failed"){
              setText("‚ùå Paiement refus√©. Contacte le support WhatsApp.");
              setTag("bad","REFUS√â");
              return;
            }

            setText("‚è≥ En attente‚Ä¶ (" + tries + "/" + MAX_TRIES + ")");
            setTag("warn","PENDING");
          }

        }catch(e){
          console.error("WAIT RPC error:", e);
          setText("‚ö†Ô∏è Erreur RPC. Nouvelle tentative‚Ä¶");
          setTag("warn","RETRY");
        }

        await new Promise(r=>setTimeout(r, DELAY));
      }

      setText("‚è≥ Toujours en attente. Contacte le support si besoin.");
      setTag("warn","ATTENTE");
    }

    $("btnRetry").addEventListener("click", ()=>{ tries = 0; loop(); });
    $("btnSupport").addEventListener("click", ()=>{
      wa("DIGIY ‚Äî Support validation\n\nReference: " + ref + "\nMerci de v√©rifier et confirmer si OK.");
    });

    loop();
  })();
  </script>
</body>
</html>
