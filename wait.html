<script>
(async function(){
  "use strict";

  const SUPABASE_URL = window.DIGIY_SUPABASE_URL;
  const SUPABASE_ANON_KEY = window.DIGIY_SUPABASE_ANON_KEY;

  const sb = window.supabase?.createClient?.(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession:false, autoRefreshToken:false, detectSessionInUrl:false }
  });

  const $ = (id)=>document.getElementById(id);
  const qp = new URLSearchParams(location.search);

  const ref = (qp.get("ref") || "").trim();
  const fallbackModule = (qp.get("module") || "").trim().toUpperCase();
  const fallbackSlug = (qp.get("slug") || "").trim();

  function setText(t){
    const el = $("waitText") || $("status") || document.body;
    if(el) el.textContent = t;
  }

  function buildModuleUrl(module, slug){
    // ✅ mapping simple (adapte si tu as digiy_module_redirects)
    const map = {
      DRIVER: "https://driver.digiylyfe.com/?slug=",
      LOC: "https://loc.digiylyfe.com/?slug=",
      RESTO: "https://resto.digiylyfe.com/?slug=",
      POS: "https://pos.digiylyfe.com/?slug=",
      MARKET: "https://market.digiylyfe.com/?slug=",
      EXPLORE: "https://explore.digiylyfe.com/?slug=",
      FRET_PRO: "https://fret.digiylyfe.com/?slug=",
      FRET_CLIENT_PRO: "https://fret-client.digiylyfe.com/?slug=",
      RESA_TABLE: "https://resa.digiylyfe.com/?slug=",
      NOTABLE: "https://notable.digiylyfe.com/?slug="
    };
    const base = map[module] || null;
    if(!base) return null;
    return base + encodeURIComponent(slug || "");
  }

  if(!sb){
    setText("⚠️ Supabase non chargé. Réessaie.");
    return;
  }

  if(!ref){
    setText("⚠️ Référence manquante (ref).");
    return;
  }

  setText("⏳ Validation en cours…");

  let tries = 0;
  const MAX_TRIES = 90;          // ~3 min si 2s
  const DELAY_MS = 2000;

  while(tries < MAX_TRIES){
    tries++;

    try{
      const { data, error } = await sb.rpc("digiy_pay_wait_status", { p_reference: ref });
      if(error) throw error;

      if(!data?.ok){
        setText("⚠️ Paiement introuvable. Contact support.");
        return;
      }

      const status = String(data.status || "pending").toLowerCase();
      const module = String(data.module || fallbackModule || "").toUpperCase();
      const slug = String(data.slug || fallbackSlug || "").trim();

      if(status === "confirmed" || status === "active"){
        if(!module || !slug){
          setText("✅ Confirmé. Mais module/slug manquant. Contact support.");
          return;
        }
        const url = buildModuleUrl(module, slug);
        if(!url){
          setText("✅ Confirmé. Module inconnu: " + module);
          return;
        }
        setText("✅ Confirmé. Redirection…");
        location.href = url;
        return;
      }

      if(status === "rejected" || status === "failed"){
        setText("❌ Paiement refusé. Contact support WhatsApp.");
        return;
      }

      // pending
      setText("⏳ En attente de validation… (" + tries + "/" + MAX_TRIES + ")");
    }catch(e){
      setText("⚠️ Erreur réseau. Nouvelle tentative…");
      console.error(e);
    }

    await new Promise(r=>setTimeout(r, DELAY_MS));
  }

  setText("⏳ Toujours en attente. Si besoin, contacte le support WhatsApp.");
})();
</script>
