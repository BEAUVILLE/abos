<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>DIGIY PAY • Validation</title>
  <meta name="theme-color" content="#0b1020"/>
  <style>
    :root{--bg:#0b1020;--card:rgba(255,255,255,.04);--line:rgba(148,163,184,.22);--ink:#f8fafc;--muted:rgba(226,232,240,.75);--cyan:#38bdf8;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu; background:var(--bg); color:var(--ink); display:flex; min-height:100vh; align-items:center; justify-content:center;}
    .card{max-width:560px;width:92%; background:var(--card); border:1px solid var(--line); border-radius:18px; padding:18px 18px 14px;}
    .big{font-size:18px; font-weight:800; letter-spacing:.2px}
    .muted{color:var(--muted); font-size:14px; line-height:1.45; margin-top:6px}
    .bar{height:10px; background:rgba(148,163,184,.20); border-radius:999px; overflow:hidden; margin:14px 0 10px}
    .bar>i{display:block;height:100%;width:35%;background:var(--cyan);border-radius:999px;animation:load 1.1s infinite ease-in-out;}
    @keyframes load{0%{transform:translateX(-120%)}100%{transform:translateX(320%)}}
    .row{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .btn{flex:1; min-width:170px; padding:12px 14px; border-radius:12px; border:1px solid rgba(148,163,184,.25); background:rgba(255,255,255,.06); color:var(--ink); cursor:pointer; font-weight:800}
    .mini{font-size:12px; opacity:.75; margin-top:10px}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas; font-size:12px}
  </style>
</head>
<body>
  <div class="card">
    <div class="big">On valide ton paiement…</div>
    <div class="muted" id="st">Patiente un instant. Dès que c’est actif, on te renvoie automatiquement.</div>
    <div class="bar"><i></i></div>
    <div class="mini" id="dbg"></div>

    <div class="row">
      <button class="btn" id="retry">Relancer</button>
      <button class="btn" id="support">Support WhatsApp</button>
    </div>
  </div>

<script>
(() => {
  // SUPABASE_URL="https://wesqmwjjtsefyjnluosj.supabase.co"
SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA"

  const qs = new URLSearchParams(location.search);
  const ref = qs.get("ref");

  const st  = document.getElementById("st");
  const dbg = document.getElementById("dbg");

  document.getElementById("support").onclick = () => {
    const msg = "DIGIY: je suis bloqué sur la validation. REF=" + (ref || "");
    window.location.href = "https://wa.me/221771342889?text=" + encodeURIComponent(msg);
  };

  document.getElementById("retry").onclick = () => poll(true);

  if (!ref) {
    st.textContent = "REF manquante. Reviens via le lien de paiement.";
    dbg.innerHTML = "Exemple: <code>?ref=XXXX</code>";
    return;
  }

  async function rpc(name, params) {
    const r = await fetch(`${SUPABASE_URL}/rest/v1/rpc/${name}`, {
      method: "POST",
      headers: {
        "apikey": SUPABASE_ANON,
        "Authorization": `Bearer ${SUPABASE_ANON}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(params)
    });
    const j = await r.json().catch(() => ({}));
    return { ok: r.ok, status: r.status, data: j };
  }

  let running = false;

  async function poll(force=false) {
    if (running && !force) return;
    running = true;

    st.textContent = "Validation en cours…";
    dbg.textContent = "REF=" + ref;

    for (let i=0; i<120; i++) { // ~6 minutes
      const res = await rpc("digiy_pay_check_order", { p_payment_ref: ref });

      if (res.ok && res.data?.ok && res.data?.status === "active") {
        const url = res.data.url;
        if (url) {
          st.textContent = "Activation OK. Redirection…";
          setTimeout(() => window.location.href = url, 450);
          return;
        }
        st.textContent = "Activation OK, mais lien introuvable. Contact support.";
        dbg.textContent = "REF=" + ref;
        return;
      }

      if (!res.ok) {
        dbg.textContent = "Erreur (" + res.status + ") • REF=" + ref;
      } else {
        dbg.textContent = "En attente… • REF=" + ref;
      }

      await new Promise(r => setTimeout(r, 3000));
    }

    st.textContent = "Toujours en attente. Contacte support si besoin.";
    dbg.textContent = "REF=" + ref;
  }

  poll();
})();
</script>
</body>
</html>
