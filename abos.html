<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DIGIY ABOS Cockpit</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
body{font-family:Arial;background:#0b1020;color:#fff;margin:0;padding:20px}
.card{background:#111827;padding:20px;border-radius:10px;margin-bottom:20px}
input,button{padding:10px;margin:5px 0;border-radius:6px;border:none}
button{cursor:pointer}
.btn-ok{background:#22c55e;color:#000}
.btn-no{background:#ef4444;color:#fff}
.pending{color:#facc15}
.validated{color:#22c55e}
.rejected{color:#ef4444}
img{max-width:200px;border-radius:8px;margin-top:10px}
</style>
</head>
<body>

<h2>ðŸ¦… DIGIY ABOS Cockpit</h2>

<div id="loginCard" class="card">
  <h3>Connexion Admin</h3>
  <input id="email" type="email" placeholder="Email admin">
  <input id="password" type="password" placeholder="Mot de passe">
  <button onclick="login()">Se connecter</button>
  <div id="loginMsg"></div>
</div>

<div id="cockpit" style="display:none">

<div class="card">
  <button onclick="loadOrders()">ðŸ”„ RafraÃ®chir</button>
  <button onclick="logout()">ðŸšª DÃ©connexion</button>
</div>

<div id="orders"></div>

</div>

<script>
const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
const SUPABASE_ANON_KEY = "REMPLACE_PAR_TA_ANON_KEY";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

async function login(){
  const email = document.getElementById("email").value;
  const password = document.getElementById("password").value;
  const { error } = await supabase.auth.signInWithPassword({ email, password });
  if(error){
    document.getElementById("loginMsg").innerText = error.message;
  }else{
    document.getElementById("loginCard").style.display="none";
    document.getElementById("cockpit").style.display="block";
    loadOrders();
  }
}

async function logout(){
  await supabase.auth.signOut();
  location.reload();
}

async function loadOrders(){
  const { data, error } = await supabase
    .from("digiy_pay_orders")
    .select("*")
    .order("created_at",{ascending:false});

  if(error){ alert(error.message); return; }

  const container = document.getElementById("orders");
  container.innerHTML="";

  for(const o of data){
    const card = document.createElement("div");
    card.className="card";

    const statusClass = o.status;

    card.innerHTML = `
      <strong>${o.plan}</strong> - ${o.amount} FCFA
      <div class="${statusClass}">${o.status}</div>
      <div>Date: ${new Date(o.created_at).toLocaleString()}</div>
      <div>Proof path: ${o.proof_path}</div>
      <div id="img-${o.id}">Chargement image...</div>
      <button class="btn-ok" onclick="validateOrder('${o.id}')">Valider</button>
      <button class="btn-no" onclick="rejectOrder('${o.id}')">Rejeter</button>
    `;

    container.appendChild(card);

    if(o.proof_path){
      const { data: signed } = await supabase
        .storage
        .from("pay-proofs")
        .createSignedUrl(o.proof_path, 60);

      if(signed){
        document.getElementById("img-"+o.id).innerHTML =
          `<img src="${signed.signedUrl}">`;
      }
    }
  }
}

async function validateOrder(id){
  await supabase
    .from("digiy_pay_orders")
    .update({status:"validated", validated_at:new Date()})
    .eq("id",id);
  loadOrders();
}

async function rejectOrder(id){
  await supabase
    .from("digiy_pay_orders")
    .update({status:"rejected", validated_at:new Date()})
    .eq("id",id);
  loadOrders();
}
</script>

</body>
</html>
