<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DIGIY COCKPIT ‚Äî Paiements</title>

  <!-- ‚úÖ Supabase JS (OBLIGATOIRE) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ‚úÖ DIGIY ENV (inline) -->
  <script>
    window.DIGIY_SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
    window.DIGIY_SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
  </script>

  <style>
    body{margin:0;font-family:system-ui;background:#061b14;color:#eafff1}
    .wrap{max-width:980px;margin:0 auto;padding:16px}
    .card{background:#0b2a1f;border:1px solid rgba(255,255,255,.14);border-radius:18px;padding:14px}
    h1{margin:0 0 10px;font-size:18px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.12);vertical-align:top}
    th{color:rgba(234,255,241,.75);text-align:left;font-weight:900}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .btn{border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.12);color:#eafff1;padding:8px 10px;border-radius:12px;cursor:pointer;font-weight:900}
    .btn.ok{border-color:rgba(34,197,94,.45)}
    .btn.bad{border-color:rgba(239,68,68,.45)}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    .muted{color:rgba(234,255,241,.75)}
    .top{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <h1>ü¶Ö DIGIY COCKPIT ‚Äî Paiements pending</h1>
          <div class="muted">Confirme ‚Üí active module + boost. Refuse ‚Üí rejet + raison.</div>
        </div>
        <button class="btn" id="btnReload">üîÑ Recharger</button>
      </div>

      <div style="margin:10px 0" class="muted" id="info">Chargement‚Ä¶</div>

      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Ref</th>
            <th>T√©l</th>
            <th>Module / Plan</th>
            <th>Montant</th>
            <th>Boost</th>
            <th>Slug</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

<script>
(async function(){
  "use strict";

  const $ = (id)=>document.getElementById(id);
  const rowsEl = $("rows");
  const infoEl = $("info");

  // ‚úÖ Anti-crash : lib supabase-js
  if(!window.supabase || typeof window.supabase.createClient !== "function"){
    infoEl.textContent = "‚ùå Supabase-js non charg√©. V√©rifie le <script src=...supabase-js>";
    return;
  }

  const SUPABASE_URL = (window.DIGIY_SUPABASE_URL || "").trim();
  const SUPABASE_ANON_KEY = (window.DIGIY_SUPABASE_ANON_KEY || "").trim();

  if(!SUPABASE_URL || !SUPABASE_ANON_KEY){
    infoEl.textContent = "‚ùå Config manquante: DIGIY_SUPABASE_URL / DIGIY_SUPABASE_ANON_KEY";
    return;
  }

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth:{ persistSession:false, autoRefreshToken:false, detectSessionInUrl:false }
  });

  function esc(s){ return String(s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
  function fcfa(n){ return (Number(n||0)).toLocaleString("fr-FR")+" FCFA"; }

  // ‚úÖ Charge via RPC (RLS-friendly)
  async function load(){
    infoEl.textContent = "‚è≥ Chargement‚Ä¶";
    rowsEl.innerHTML = "";

    const { data, error } = await sb.rpc("digiy_cockpit_list_pending", { p_limit: 100 });

    if(error){
      console.error(error);
      infoEl.textContent = "‚ùå Erreur RPC: " + error.message;
      return;
    }

    const rows = data?.rows || [];
    infoEl.textContent = "‚úÖ Pending: " + (rows.length || 0);

    rowsEl.innerHTML = rows.map(r=>{
      return `
        <tr>
          <td class="muted">${esc(r.created_at)}</td>
          <td class="mono">${esc(r.reference)}</td>
          <td class="mono">${esc(r.pro_phone)}</td>
          <td>${esc(r.module)}<div class="muted">${esc(r.plan||"")}</div></td>
          <td class="mono">${fcfa(r.amount)}</td>
          <td class="mono">${esc(r.boost_code||"‚Äî")}<div class="muted">${r.boost_amount_xof?fcfa(r.boost_amount_xof):""}</div></td>
          <td class="mono">${esc(r.slug||"‚Äî")}</td>
          <td>
            <div class="row">
              <button class="btn ok" data-act="confirm" data-ref="${esc(r.reference)}">‚úÖ Confirmer</button>
              <button class="btn bad" data-act="reject" data-ref="${esc(r.reference)}">‚ùå Refuser</button>
            </div>
          </td>
        </tr>
      `;
    }).join("");

    rowsEl.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const act = btn.getAttribute("data-act");
        const ref = btn.getAttribute("data-ref");
        btn.disabled = true;

        try{
          if(act === "confirm"){
            const { error } = await sb.rpc("digiy_cockpit_confirm_payment", {
              p_reference: ref,
              p_activated_by: null
            });
            if(error) throw error;
            alert("‚úÖ Confirm√©: " + ref);
          } else {
            const reason = prompt("Raison refus (optionnel) :") || null;
            const { error } = await sb.rpc("digiy_cockpit_reject_payment", {
              p_reference: ref,
              p_reason: reason
            });
            if(error) throw error;
            alert("‚ùå Refus√©: " + ref);
          }

          await load();
        }catch(e){
          console.error(e);
          alert("Erreur: " + (e?.message || e));
          btn.disabled = false;
        }
      });
    });
  }

  $("btnReload").addEventListener("click", load);
  load();
})();
</script>
</body>
</html>
