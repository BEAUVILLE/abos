<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>DIGIY PAY ‚Äî Cockpit Admin</title>
  <meta name="theme-color" content="#0b1020"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#0b1020; --card:#111827; --line:rgba(255,255,255,.12);
      --text:#fff; --muted:rgba(255,255,255,.75);
      --ok:#22c55e; --warn:#facc15; --bad:#ef4444; --gold:#f59e0b;
      --radius:12px;
    }
    body{font-family:Arial,system-ui;background:var(--bg);color:var(--text);margin:0;padding:20px}
    h2{margin:0 0 14px}
    h3{margin:0 0 10px}
    .card{background:var(--card);padding:16px;border-radius:var(--radius);margin-bottom:14px;border:1px solid var(--line)}
    input,button,select,textarea{
      padding:10px;margin:6px 0;border-radius:8px;border:1px solid var(--line);
      background:rgba(0,0,0,.25); color:var(--text)
    }
    button{cursor:pointer;font-weight:700}
    button:disabled{opacity:.55;cursor:not-allowed}
    .btn-ok{background:rgba(34,197,94,.18);border-color:rgba(34,197,94,.5)}
    .btn-no{background:rgba(239,68,68,.18);border-color:rgba(239,68,68,.5)}
    .btn-warn{background:rgba(250,204,21,.18);border-color:rgba(250,204,21,.5)}
    .btn-gold{background:rgba(245,158,11,.16);border-color:rgba(245,158,11,.55)}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:flex-end}
    .row > *{flex:1;min-width:220px}
    .small{font-size:13px;color:var(--muted);line-height:1.35}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}

    .pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px}
    .pill.pending{border-color:rgba(250,204,21,.55);color:var(--warn)}
    .pill.validated{border-color:rgba(34,197,94,.55);color:var(--ok)}
    .pill.rejected{border-color:rgba(239,68,68,.55);color:var(--bad)}
    .pill.unknown{border-color:rgba(255,255,255,.25);color:rgba(255,255,255,.8)}

    .sep{height:1px;background:var(--line);margin:12px 0}
    img{max-width:260px;border-radius:10px;margin-top:10px;border:1px solid rgba(255,255,255,.12)}
    a{color:var(--warn);text-decoration:none}
    a:hover{text-decoration:underline}

    .status{
      padding:10px 12px;border-radius:10px;border:1px solid var(--line);
      background:rgba(0,0,0,.18);display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap
    }
    .status.ok{border-color:rgba(34,197,94,.45)}
    .status.warn{border-color:rgba(250,204,21,.45)}
    .status.bad{border-color:rgba(239,68,68,.45)}

    .grid-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .grid-actions button{min-width:220px;flex:1}
    textarea{width:100%;min-height:64px;resize:vertical;background:rgba(0,0,0,.18)}
    .mini{
      display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:6px
    }
    .mini > *{min-width:180px;flex:1}
    .k{color:rgba(255,255,255,.88)}
  </style>
</head>

<body>
  <h2>ü¶Ö DIGIY PAY ‚Äî Cockpit Admin</h2>

  <div class="status warn" id="statusBox">
    <div id="statusText">‚è≥ Pr√™t. Connecte-toi.</div>
    <div class="mono" id="statusTag">BOOT</div>
  </div>

  <div class="sep"></div>

  <!-- LOGIN -->
  <div id="loginCard" class="card">
    <h3>üîê Connexion Admin</h3>
    <div class="row">
      <div>
        <div class="small">Email</div>
        <input id="email" type="email" placeholder="Email admin">
      </div>
      <div>
        <div class="small">Mot de passe</div>
        <input id="password" type="password" placeholder="Mot de passe">
      </div>
    </div>
    <div class="row">
      <button class="btn-ok" id="btnLogin" type="button">Se connecter</button>
      <button class="btn-no" id="btnLogout" type="button" disabled>D√©connexion</button>
    </div>
    <div class="small" id="loginMsg"></div>
  </div>

  <!-- COCKPIT -->
  <div id="cockpit" style="display:none">
    <div class="card">
      <div class="row">
        <div>
          <div class="small">Filtre status</div>
          <select id="filterStatus">
            <option value="pending" selected>pending</option>
            <option value="validated">validated</option>
            <option value="rejected">rejected</option>
            <option value="all">all</option>
          </select>
        </div>

        <div>
          <div class="small">Auto-refresh</div>
          <select id="autoRefresh">
            <option value="off" selected>off</option>
            <option value="10">10s</option>
            <option value="20">20s</option>
            <option value="30">30s</option>
          </select>
        </div>

        <div>
          <div class="small">Actions</div>
          <button class="btn-gold" id="btnReload" type="button">üîÑ Rafra√Æchir</button>
        </div>
      </div>

      <div class="small" id="meBox" style="margin-top:10px;"></div>
      <div class="small" id="hintBox" style="margin-top:6px;"></div>
    </div>

    <div id="orders"></div>
  </div>

<script>
(function(){
  "use strict";

  /* ==================== CONFIG ==================== */
  const SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";

  const PROOF_BUCKET = "pay-proofs";
  const SIGNED_TTL_SECONDS = 300; // 5 min

  // ‚úÖ ADN DIGIY : Valider = appeler le BACKBONE (cr√©e/active digiy_subscriptions)
  // Signatures vues chez toi :
  // digiy_pay_admin_validate_order_auto(p_payment_ref, p_phone, p_module, p_plan, p_billing_cycle, p_annual_months_to_pay)
  const RPC_VALIDATE_AUTO = "digiy_pay_admin_validate_order_auto";

  // Refuser : on met l'order en rejected (simple, robuste)
  // (si plus tard tu veux un RPC, tu le rajoutes)
  const USE_REJECT_RPC = false;
  const RPC_REJECT_BY_REF = "digiy_pay_admin_reject_by_reference"; // existe chez toi

  /* ==================== UI HELPERS ==================== */
  const $ = (id)=>document.getElementById(id);

  function setStatus(text, tone, tag){
    const box = $("statusBox");
    $("statusText").textContent = text || "";
    $("statusTag").textContent = tag || "‚Äî";
    box.className = "status " + (tone || "warn");
  }

  function escapeHtml(s){
    return String(s ?? "").replace(/[<>&"]/g, (m)=>({ "<":"&lt;", ">":"&gt;", "&":"&amp;", "\"":"&quot;" }[m]));
  }

  function fmtDate(iso){
    try{ return new Date(iso).toLocaleString("fr-FR"); }
    catch(_){ return iso || "‚Äî"; }
  }

  function prettyFCFA(n){
    const x = Number(n||0);
    if(!x) return "‚Äî";
    return x.toLocaleString("fr-FR") + " FCFA";
  }

  function pill(status){
    const s = String(status||"pending").toLowerCase();
    const cls = (s === "validated" || s === "rejected" || s === "pending") ? s : "unknown";
    return `<span class="pill ${cls}">${escapeHtml(cls.toUpperCase())}</span>`;
  }

  function digitsOnlyPhone(p){
    return String(p||"").replace(/\D/g,"");
  }

  // üîé inf√©rer module depuis slug (fallback)
  function inferModuleFromSlug(slug){
    const s = String(slug||"").toLowerCase();
    if(s.includes("driver")) return "DRIVER";
    if(s.includes("loc"))    return "LOC";
    if(s.includes("resto"))  return "RESTO";
    if(s.includes("pos"))    return "POS";
    if(s.includes("market")) return "MARKET";
    if(s.includes("notable"))return "NOTABLE";
    if(s.includes("resa"))   return "RESA_TABLE";
    if(s.includes("explore"))return "EXPLORE";
    return "";
  }

  function inferCycleFromPlan(plan){
    const p = String(plan||"").toLowerCase();
    if(p.includes("annual") || p.includes("annuel") || p.includes("year")) return "yearly";
    if(p.includes("quarter") || p.includes("trimes")) return "quarterly";
    return "monthly";
  }

  function annualMonthsToPay(cycle){
    const c = String(cycle||"monthly").toLowerCase();
    if(c === "yearly" || c === "annual" || c === "annuel") return 12;
    if(c === "quarterly" || c === "trimestriel") return 3;
    return 1;
  }

  /* ==================== SUPABASE ==================== */
  if(!window.supabase){
    setStatus("üî¥ Supabase JS non charg√©", "bad", "ERR");
    return;
  }

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true, detectSessionInUrl: true }
  });

  // console debug
  window.DIGIY_SB = supabase;

  /* ==================== AUTH ==================== */
  const loginCard = $("loginCard");
  const cockpit = $("cockpit");
  const loginMsg = $("loginMsg");
  const meBox = $("meBox");
  const hintBox = $("hintBox");

  const btnLogin = $("btnLogin");
  const btnLogout = $("btnLogout");
  const btnReload = $("btnReload");

  async function boot(){
    setStatus("‚è≥ V√©rification session‚Ä¶", "warn", "AUTH");
    const { data } = await supabase.auth.getSession();
    if(data?.session?.user){
      onLoggedIn(data.session.user);
      await loadOrders();
    }else{
      setStatus("üîê Connecte-toi (admin).", "warn", "LOGIN");
    }
  }

  function onLoggedIn(user){
    loginCard.style.display = "none";
    cockpit.style.display = "block";
    btnLogout.disabled = false;
    btnLogin.disabled = true;

    meBox.innerHTML =
      `Connect√© : <b>${escapeHtml(user.email||"")}</b><br/><span class="mono">uid: ${escapeHtml(user.id||"")}</span>`;

    hintBox.textContent =
      "‚úÖ Valider = RPC BACKBONE (digiy_pay_admin_validate_order_auto). Refuser = status=rejected. Preuve = signed url + nouvel onglet.";

    setStatus("‚úÖ Connect√©. Pr√™t.", "ok", "READY");
  }

  async function login(){
    const email = String($("email").value||"").trim();
    const password = String($("password").value||"").trim();
    if(!email || !password){
      setStatus("‚ö†Ô∏è Email + mot de passe requis", "warn", "FORM");
      return;
    }

    btnLogin.disabled = true;
    setStatus("‚è≥ Connexion‚Ä¶", "warn", "AUTH");

    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if(error){
      loginMsg.textContent = error.message;
      setStatus("üî¥ Connexion KO", "bad", "ERR");
      btnLogin.disabled = false;
      return;
    }

    loginMsg.textContent = "";
    onLoggedIn(data.user);
    btnLogin.disabled = false;
    await loadOrders();
  }

  async function logout(){
    await supabase.auth.signOut();
    location.reload();
  }

  btnLogin.addEventListener("click", login);
  btnLogout.addEventListener("click", logout);
  btnReload.addEventListener("click", loadOrders);

  document.addEventListener("keydown", (e)=>{
    if(e.key === "Enter" && loginCard.style.display !== "none"){
      login();
    }
  });

  /* ==================== AUTO-REFRESH ==================== */
  let timer = null;
  function stopAuto(){ if(timer){ clearInterval(timer); timer = null; } }
  function startAuto(seconds){
    stopAuto();
    if(!seconds) return;
    timer = setInterval(loadOrders, seconds * 1000);
  }

  $("autoRefresh").addEventListener("change", ()=>{
    const v = $("autoRefresh").value;
    if(v === "off"){ stopAuto(); return; }
    const s = parseInt(v,10);
    if(Number.isFinite(s) && s > 0) startAuto(s);
  });

  $("filterStatus").addEventListener("change", loadOrders);

  /* ==================== DATA ==================== */

  async function loadOrders(){
    const filter = $("filterStatus").value;
    setStatus("‚è≥ Chargement orders‚Ä¶", "warn", "LOAD");

    // ‚úÖ Colonnes EXACTES de ton sch√©ma :
    // id, created_at, phone, code, plan, amount, slug, proof_path, status, validated_at, validated_by
    let q = supabase
      .from("digiy_pay_orders")
      .select("id,created_at,phone,code,plan,amount,slug,proof_path,status,validated_at,validated_by")
      .order("created_at",{ascending:false})
      .limit(300);

    if(filter && filter !== "all"){
      q = q.eq("status", filter);
    }

    const { data, error } = await q;

    if(error){
      setStatus("‚ö†Ô∏è Lecture bloqu√©e (RLS ?)", "warn", "RLS/SQL");
      $("orders").innerHTML = `
        <div class="card">
          <h3>üõ°Ô∏è Lecture bloqu√©e</h3>
          <div class="small">
            Erreur: <span class="mono">${escapeHtml(error.message||"")}</span><br/>
            Si <b>RLS</b>: v√©rifie policy SELECT admin-only (digiy_admins).<br/>
            Si <b>colonne</b>: le SELECT ne match pas le sch√©ma.
          </div>
        </div>
      `;
      return;
    }

    renderOrders(data || []);
    setStatus("‚úÖ Orders charg√©s (" + (data?.length||0) + ")", "ok", "OK");
  }

  async function getSignedUrl(path){
    try{
      const { data, error } = await supabase
        .storage
        .from(PROOF_BUCKET)
        .createSignedUrl(path, SIGNED_TTL_SECONDS);

      if(error) throw error;
      return data?.signedUrl || "";
    }catch(_){
      return "";
    }
  }

  function renderOrders(list){
    const container = $("orders");
    container.innerHTML = "";

    if(!list.length){
      container.innerHTML = `<div class="card"><div class="small">Aucun order.</div></div>`;
      return;
    }

    for(const o of list){
      const card = document.createElement("div");
      card.className = "card";

      const status = String(o.status || "pending").toLowerCase();
      const phone = digitsOnlyPhone(o.phone) || "‚Äî";
      const slug  = o.slug  || "";
      const plan  = o.plan  || "‚Äî";
      const code  = (o.code === null || o.code === undefined) ? "" : String(o.code);
      const amt   = prettyFCFA(o.amount);
      const proofPath = o.proof_path || "";

      // ‚úÖ R√©f√©rence technique : on fabrique un payment_ref stable (ADN)
      // -> √©vite toute d√©pendance √† une colonne "reference" qui n'existe pas
      const paymentRef = "order_" + o.id;

      // module/cycle : inf√©r√©s + editable
      const defaultModule = inferModuleFromSlug(slug) || "DRIVER";
      const defaultCycle  = inferCycleFromPlan(plan) || "monthly";

      card.innerHTML = `
        <div class="row" style="align-items:flex-start;">
          <div>
            <div><b>${escapeHtml(plan)}</b> ${code ? `<span class="mono">(code:${escapeHtml(code)})</span>` : ""}</div>
            <div class="small">Montant: <b>${escapeHtml(amt)}</b></div>
            <div class="small">Cr√©√©: ${escapeHtml(fmtDate(o.created_at))}</div>
            <div class="small mono">id: ${escapeHtml(o.id)}</div>
            <div class="small mono">payment_ref: ${escapeHtml(paymentRef)}</div>
            ${o.validated_at ? `<div class="small">validated_at: <span class="mono">${escapeHtml(fmtDate(o.validated_at))}</span></div>` : ""}
          </div>

          <div>
            <div class="small">Client</div>
            <div><b>${escapeHtml(phone)}</b></div>
            <div class="small">slug: <span class="mono">${escapeHtml(slug)}</span></div>
            <div class="small">status: ${pill(status)}</div>

            <div class="mini">
              <div>
                <div class="small">Module (pour activation)</div>
                <select data-mod="${escapeHtml(o.id)}">
                  ${["DRIVER","LOC","RESTO","POS","MARKET","NOTABLE","EXPLORE","RESA_TABLE","FRET_PRO","FRET_CLIENT_PRO"]
                    .map(m => `<option value="${m}" ${m===defaultModule?"selected":""}>${m}</option>`).join("")}
                </select>
              </div>
              <div>
                <div class="small">Cycle</div>
                <select data-cyc="${escapeHtml(o.id)}">
                  ${["monthly","yearly","quarterly"].map(c => `<option value="${c}" ${c===defaultCycle?"selected":""}>${c}</option>`).join("")}
                </select>
              </div>
            </div>
          </div>

          <div>
            <div class="small">Preuve</div>
            <button class="btn-warn" type="button"
              data-proof="${escapeHtml(proofPath)}"
              data-id="${escapeHtml(o.id)}">üì∏ Voir preuve</button>

            <div class="small mono" style="margin-top:6px;word-break:break-all;">
              ${escapeHtml(proofPath || "‚Äî")}
            </div>
            <div id="img-${escapeHtml(o.id)}" class="small" style="margin-top:8px;"></div>
          </div>
        </div>

        <div class="sep"></div>

        <div>
          <div class="small">Note admin (optionnel)</div>
          <textarea maxlength="300"
            placeholder="Ex: re√ßu v√©rifi√© / test atelier / etc."
            data-note="${escapeHtml(o.id)}"></textarea>
        </div>

        <div class="grid-actions">
          <button class="btn-ok" type="button"
            data-act="validate"
            data-id="${escapeHtml(o.id)}"
            data-ref="${escapeHtml(paymentRef)}"
          >‚úÖ Valider (rail PAY)</button>

          <button class="btn-no" type="button"
            data-act="reject"
            data-id="${escapeHtml(o.id)}"
            data-ref="${escapeHtml(paymentRef)}"
          >‚ùå Refuser</button>
        </div>
      `;

      container.appendChild(card);
    }

    // PROOF buttons
    container.querySelectorAll("button[data-proof]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const path = btn.getAttribute("data-proof") || "";
        const id   = btn.getAttribute("data-id") || "";
        if(!path){ alert("proof_path manquant."); return; }

        btn.disabled = true;
        const oldText = btn.textContent;
        btn.textContent = "‚è≥ Chargement‚Ä¶";

        const url = await getSignedUrl(path);

        btn.textContent = oldText;
        btn.disabled = false;

        if(!url){
          alert("Impossible d'ouvrir la preuve (signed url). V√©rifie Storage policy du bucket.");
          return;
        }

        const box = document.getElementById("img-" + id);
        if(box){
          box.innerHTML = "";

          const openBtn = document.createElement("button");
          openBtn.className = "btn-warn";
          openBtn.type = "button";
          openBtn.textContent = "üìÇ Ouvrir la preuve (popup)";

          openBtn.onclick = function(){
            const win = window.open(url, "_blank", "noopener,noreferrer,width=900,height=1200");
            if(!win){
              alert("Popup bloqu√©e. Autorise les popups pour ce site.");
            }
          };

          box.appendChild(openBtn);

          box.insertAdjacentHTML(
            "beforeend",
            `<div style="margin-top:10px">
              <a href="${url}" target="_blank" rel="noreferrer">Ouvrir dans un onglet</a><br/>
              <img src="${url}" alt="proof">
            </div>`
          );
        }
      });
    });

    // ACTIONS
    container.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", onAction);
    });
  }

  function getNoteFor(id){
    const ta = document.querySelector(`textarea[data-note="${CSS.escape(id)}"]`);
    return ta ? String(ta.value||"").trim().slice(0,300) : "";
  }

  function getModuleFor(id){
    const s = document.querySelector(`select[data-mod="${CSS.escape(id)}"]`);
    return s ? String(s.value||"").trim() : "";
  }

  function getCycleFor(id){
    const s = document.querySelector(`select[data-cyc="${CSS.escape(id)}"]`);
    return s ? String(s.value||"monthly").trim() : "monthly";
  }

  async function safeUpdateOrder(id, patch){
    // update best-effort (si RLS UPDATE pas activ√©e, on n'explose pas le cockpit)
    try{
      await supabase.from("digiy_pay_orders").update(patch).eq("id", id);
    }catch(_){}
  }

  async function onAction(e){
    const btn = e.currentTarget;
    const act = btn.getAttribute("data-act");
    const id  = btn.getAttribute("data-id");
    const paymentRef = btn.getAttribute("data-ref") || "";

    if(!id) return;

    const note = getNoteFor(id) || null;
    const module = getModuleFor(id);
    const billingCycle = getCycleFor(id);
    const monthsToPay = annualMonthsToPay(billingCycle);

    btn.disabled = true;
    setStatus("‚è≥ Action admin‚Ä¶", "warn", "RPC");

    try{
      if(act === "validate"){
        if(!module){
          throw new Error("Module manquant (choisis un module dans la carte).");
        }

        // 1) r√©cup√©rer l'order pour phone/plan/amount
        const { data: rows, error: e1 } = await supabase
          .from("digiy_pay_orders")
          .select("id,phone,plan,amount,status")
          .eq("id", id)
          .limit(1);

        if(e1) throw e1;
        const o = (rows && rows[0]) ? rows[0] : null;
        if(!o) throw new Error("Order introuvable.");

        const phone = digitsOnlyPhone(o.phone);
        const plan  = o.plan || "standard";

        // 2) appeler le BACKBONE (cr√©e/active subscription)
        const { data, error } = await supabase.rpc(RPC_VALIDATE_AUTO, {
          p_payment_ref: paymentRef,
          p_phone: phone,
          p_module: module,
          p_plan: plan,
          p_billing_cycle: billingCycle,
          p_annual_months_to_pay: monthsToPay
        });

        if(error) throw error;
        if(!data?.ok) throw new Error(data?.error || "rpc_failed");

        // 3) marquer l'order validated (best-effort)
        await safeUpdateOrder(id, { status: "validated", validated_at: new Date().toISOString() });

        setStatus("‚úÖ ACTIV√â : " + paymentRef, "ok", "ACTIVE");
      }

      if(act === "reject"){
        // Refus robuste : on met l'order en rejected (c‚Äôest ton cockpit, c‚Äôest SON job)
        await safeUpdateOrder(id, { status: "rejected", validated_at: new Date().toISOString() });

        // Optionnel : si tu veux aussi appeler un RPC de rejet ‚Äúpar r√©f√©rence‚Äù
        if(USE_REJECT_RPC){
          const { data, error } = await supabase.rpc(RPC_REJECT_BY_REF, {
            p_reference: paymentRef,
            p_note: note
          });
          if(error) throw error;
          if(!data?.ok) throw new Error(data?.error || "rpc_failed");
        }

        setStatus("‚ùå REFUS√â : " + paymentRef, "bad", "REJECTED");
      }

      await loadOrders();
    }catch(err){
      console.error(err);
      setStatus("üî¥ Action refus√©e", "bad", "ERR");
      alert(String(err?.message || err) + "\n\nSi 'not_admin' : v√©rifie digiy_admins(user_id = auth.uid()).");
    }finally{
      btn.disabled = false;
    }
  }

  /* ==================== START ==================== */
  boot();

})();
</script>

</body>
</html>
