<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DIGIY COCKPIT ‚Äî Paiements</title>

  <!-- ‚úÖ Supabase JS (OBLIGATOIRE) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- ‚úÖ DIGIY ENV (inline) -->
  <script>
    window.DIGIY_SUPABASE_URL = "https://wesqmwjjtsefyjnluosj.supabase.co";
    window.DIGIY_SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Indlc3Ftd2pqdHNlZnlqbmx1b3NqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzg4ODIsImV4cCI6MjA4MDc1NDg4Mn0.dZfYOc2iL2_wRYL3zExZFsFSBK6AbMeOid2LrIjcTdA";
  </script>

  <style>
    body{margin:0;font-family:system-ui;background:#061b14;color:#eafff1}
    .wrap{max-width:1040px;margin:0 auto;padding:16px}
    .card{background:#0b2a1f;border:1px solid rgba(255,255,255,.14);border-radius:18px;padding:14px;box-shadow:0 18px 50px rgba(0,0,0,.35)}
    h1{margin:0 0 6px;font-size:18px}
    .muted{color:rgba(234,255,241,.75)}
    .top{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.12);color:#eafff1;padding:8px 10px;border-radius:12px;cursor:pointer;font-weight:900}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.ok{border-color:rgba(34,197,94,.45)}
    .btn.bad{border-color:rgba(239,68,68,.45)}
    .btn.warn{border-color:rgba(245,158,11,.45)}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .pill{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.16);background:rgba(0,0,0,.10);white-space:nowrap}
    .pill.ok{border-color:rgba(34,197,94,.35);color:#bfffe0}
    .pill.bad{border-color:rgba(239,68,68,.35);color:#ffd2d2}
    table{width:100%;border-collapse:collapse;font-size:13px;margin-top:10px}
    th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,.12);vertical-align:top}
    th{color:rgba(234,255,241,.75);text-align:left;font-weight:900}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .small{font-size:12px}
    .right{text-align:right}
    .actions{min-width:190px}
    .k{font-weight:900}
    .notice{margin:10px 0;padding:10px;border-radius:14px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.10)}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <div class="top">
        <div>
          <h1>ü¶Ö DIGIY COCKPIT ‚Äî Paiements pending</h1>
          <div class="muted small">Confirme ‚Üí active module + boost. Refuse ‚Üí rejet + raison.</div>
        </div>
        <div class="row">
          <span class="pill" id="pillEnv">ENV‚Ä¶</span>
          <button class="btn" id="btnReload">üîÑ Recharger</button>
        </div>
      </div>

      <div class="notice small muted" id="info">Chargement‚Ä¶</div>

      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Ref</th>
            <th>T√©l</th>
            <th>Module / Plan</th>
            <th class="right">Montant</th>
            <th>Boost</th>
            <th>Slug</th>
            <th class="actions">Actions</th>
          </tr>
        </thead>
        <tbody id="rows"></tbody>
      </table>
    </div>
  </div>

<script>
(async function(){
  "use strict";

  const SUPABASE_URL = (window.DIGIY_SUPABASE_URL || "").trim();
  const SUPABASE_ANON_KEY = (window.DIGIY_SUPABASE_ANON_KEY || "").trim();

  const $ = (id)=>document.getElementById(id);
  const rowsEl = $("rows");
  const infoEl = $("info");
  const pillEnv = $("pillEnv");

  function esc(s){ return String(s||"").replace(/[&<>"']/g,m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }
  function fcfa(n){ return (Number(n||0)).toLocaleString("fr-FR")+" FCFA"; }

  // ‚úÖ check ENV
  if(!SUPABASE_URL || !SUPABASE_ANON_KEY){
    pillEnv.textContent = "ENV manquant";
    pillEnv.className = "pill bad";
    infoEl.textContent = "‚ùå Config manquante: DIGIY_SUPABASE_URL / DIGIY_SUPABASE_ANON_KEY";
    return;
  }
  pillEnv.textContent = "ENV OK";
  pillEnv.className = "pill ok";

  // ‚úÖ check supabase-js loaded
  if(!window.supabase || typeof window.supabase.createClient !== "function"){
    pillEnv.textContent = "Supabase JS KO";
    pillEnv.className = "pill bad";
    infoEl.textContent = "‚ùå Supabase JS non charg√©. V√©rifie le <script src='@supabase/supabase-js@2'>.";
    return;
  }

  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth:{ persistSession:false, autoRefreshToken:false, detectSessionInUrl:false }
  });

  function renderEmpty(msg){
    rowsEl.innerHTML = "";
    infoEl.textContent = msg;
  }

  function dedupeByReference(rows){
    const seen = new Set();
    const out = [];
    for(const r of (rows||[])){
      const key = String(r.reference||"");
      if(!key) continue;
      if(seen.has(key)) continue;
      seen.add(key);
      out.push(r);
    }
    return out;
  }

  async function load(){
    infoEl.textContent = "‚è≥ Chargement‚Ä¶";
    rowsEl.innerHTML = "";

    const { data, error } = await sb
      .from("subscription_payments")
      .select("created_at,reference,pro_phone,module,plan,amount,boost_code,boost_amount_xof,slug,status")
      .eq("status","pending")
      .order("created_at",{ascending:false})
      .limit(200);

    if(error){
      console.error(error);
      renderEmpty("‚ùå Erreur: " + error.message);
      return;
    }

    const rows = dedupeByReference(data || []);
    infoEl.textContent = "‚úÖ Pending: " + rows.length + ( (data?.length||0) !== rows.length ? " (doublons masqu√©s)" : "" );

    if(!rows.length){
      rowsEl.innerHTML = `<tr><td colspan="8" class="muted small">Aucun paiement pending.</td></tr>`;
      return;
    }

    rowsEl.innerHTML = rows.map(r=>{
      const boostTxt = r.boost_code ? esc(r.boost_code) : "‚Äî";
      const boostAmt = r.boost_amount_xof ? `<div class="muted small">${fcfa(r.boost_amount_xof)}</div>` : "";
      const planTxt = r.plan ? `<div class="muted small">${esc(r.plan)}</div>` : "";
      return `
        <tr>
          <td class="muted small">${esc(r.created_at)}</td>
          <td class="mono">${esc(r.reference)}</td>
          <td class="mono">${esc(r.pro_phone)}</td>
          <td><span class="k">${esc(r.module||"")}</span>${planTxt}</td>
          <td class="mono right">${fcfa(r.amount)}</td>
          <td class="mono">${boostTxt}${boostAmt}</td>
          <td class="mono">${esc(r.slug||"‚Äî")}</td>
          <td>
            <div class="row">
              <button class="btn ok" data-act="confirm" data-ref="${esc(r.reference)}">‚úÖ Confirmer</button>
              <button class="btn bad" data-act="reject" data-ref="${esc(r.reference)}">‚ùå Refuser</button>
            </div>
          </td>
        </tr>
      `;
    }).join("");

    rowsEl.querySelectorAll("button[data-act]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const act = btn.getAttribute("data-act");
        const ref = btn.getAttribute("data-ref");
        if(!ref) return;

        btn.disabled = true;

        try{
          if(act === "confirm"){
            const { data, error } = await sb.rpc("digiy_cockpit_confirm_payment", { p_reference: ref, p_activated_by: null });
            if(error) throw error;
            if(data && data.ok === false) throw new Error(data.error || "confirm_failed");
            alert("‚úÖ Confirm√©: " + ref);
          } else {
            const reason = prompt("Raison refus (optionnel) :") || null;
            const { data, error } = await sb.rpc("digiy_cockpit_reject_payment", { p_reference: ref, p_reason: reason });
            if(error) throw error;
            if(data && data.ok === false) throw new Error(data.error || "reject_failed");
            alert("‚ùå Refus√©: " + ref);
          }
          await load();
        }catch(e){
          console.error(e);
          alert("Erreur: " + (e?.message || e));
          btn.disabled = false;
        }
      });
    });
  }

  $("btnReload").addEventListener("click", load);
  load();
})();
</script>
</body>
</html>
